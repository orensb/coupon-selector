<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>砖专 砖驻专住!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        input[type="file"],
        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .url-list {
            margin-top: 20px;
        }
        
        .url-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .url-item.used {
            background: #f5f5f5;
            border-left: 4px solid #999;
            opacity: 0.7;
        }
        
        .url-item.used .url-text {
            color: #999;
        }
        
        .url-item.used .amount-text {
            color: #999;
        }
        
        .used-badge {
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .url-info {
            flex: 1;
        }
        
        .url-text {
            color: #667eea;
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-all;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
            text-decoration: underline;
            cursor: pointer;
            width: auto;
            font-size: inherit;
        }
        
        .url-text:hover {
            color: #764ba2;
            text-decoration: none;
        }
        
        .amount-text {
            color: #667eea;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .remove-btn {
            background: #dc3545;
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.show {
            display: block;
        }
        
        .used-urls {
            margin-top: 15px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }
        
        .used-urls h3 {
            color: #1976D2;
            margin-bottom: 10px;
        }
        
        .used-url-item {
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .header-bar {
            display: flex;
            justify-content: flex-end; 
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .family-info {
            color: #667eea;
            font-weight: 600;
        }
        
        .logout-btn {
            background: #dc3545;
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .url-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .remove-btn {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <form method="POST" action="/logout" style="display: inline;">
                <button type="submit" class="logout-btn">Logout</button>
            </form>
        </div>
        <h1> !砖专 砖驻专住</h1>
    
        <!-- Use Amount Section -->
        <div class="section">
            <h2>1. Use Amount</h2>
            <div id="use-message" class="message"></div>
            <div id="used-urls-display"></div>
            <div class="form-group">
                <label for="amount-input">Amount to use (shekel)</label>
                <input type="number" id="amount-input" step="0.01" min="0.01">
            </div>
            <button onclick="useAmount()">Use Amount</button>
        </div>
        
        <!-- Manual Add Section -->
        <div class="section">
            <h2>3. Add URL Manually</h2>
            <div id="add-message" class="message"></div>
            <div class="form-group">
                <label for="url-input">URL</label>
                <input type="text" id="url-input" >
            </div>
            <div class="form-group">
                <label for="add-amount-input">Amount (shekel)</label>
                <input type="number" id="add-amount-input" step="0.01" min="0.01">
            </div>
            <button onclick="addUrl()">Add URL</button>
        </div>
        
        <!-- URL List Section -->
        <div class="section">
            <h2>4. All URLs</h2>
            <div id="total-amount" style="font-weight: bold; margin-bottom: 10px;">
                Total: --
            </div>
            <div id="url-list" class="url-list">
                <div class="empty-state">Loading...</div>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="loadData()" style="width: auto; flex: 1; min-width: 150px;">Show Available URLs</button>
                <button onclick="loadAllUrls()" style="width: auto; flex: 1; min-width: 150px;">Show All URLs (Including Used)</button>
            </div>
        </div>
    </div>
    
    <script>
        // Load URLs on page load
        window.onload = function() {
            loadUrls();
        };
        
        function showMessage(elementId, message, isError = false) {
            const msgEl = document.getElementById(elementId);
            msgEl.textContent = message;
            msgEl.className = 'message ' + (isError ? 'error' : 'success') + ' show';
            setTimeout(() => {
                msgEl.classList.remove('show');
            }, 5000);
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('upload-message', 'Please select a file', true);
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('upload-message', data.message);
                    fileInput.value = '';
                    loadUrls();
                } else {
                    showMessage('upload-message', data.error, true);
                }
            } catch (error) {
                showMessage('upload-message', 'Error uploading file: ' + error.message, true);
            }
        }
        
        async function useAmount() {
            const amountInput = document.getElementById('amount-input');
            const amount = parseFloat(amountInput.value);
            
            if (!amount || amount <= 0) {
                showMessage('use-message', 'Please enter a valid amount', true);
                return;
            }
            
            try {
                const response = await fetch('/api/use-amount', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount: amount })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('use-message', data.message);
                    
                    // Display used URLs
                    if (data.used_urls && data.used_urls.length > 0) {
                        let html = '<div class="used-urls"><h3>Used URLs:</h3>';
                        data.used_urls.forEach(item => {
                            // Escape URL for onclick attribute
                            const escapedUrl = item.url.replace(/'/g, "\\'");
                            
                            html += `<div class="used-url-item">
                                <div><strong>Amount Used :</strong> ${item.amount} shekel</div>
                                <div><strong>URL:</strong> <button class="url-text" onclick="openUrl('${item.url}')">${item.url}</button></div>
                            </div>`;
                        });
                        html += '</div>';
                        document.getElementById('used-urls-display').innerHTML = html;
                    }
                    
                    amountInput.value = '';
                    loadUrls();
                } else {
                    showMessage('use-message', data.error, true);
                }
            } catch (error) {
                showMessage('use-message', 'Error: ' + error.message, true);
            }
        }
        
        async function addUrl() {
            const urlInput = document.getElementById('url-input');
            const amountInput = document.getElementById('add-amount-input');
            
            const url = urlInput.value.trim();
            const amount = parseFloat(amountInput.value);
            
            if (!url || !amount || amount <= 0) {
                showMessage('add-message', 'Please enter valid URL and amount', true);
                return;
            }
            
            try {
                const response = await fetch('/api/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url, amount: amount })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('add-message', data.message);
                    urlInput.value = '';
                    amountInput.value = '';
                    loadUrls();
                } else {
                    showMessage('add-message', data.error, true);
                }
            } catch (error) {
                showMessage('add-message', 'Error: ' + error.message, true);
            }
        }
        
        async function removeUrl(id) {
            if (!confirm('Are you sure you want to remove this URL?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: id })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    loadUrls();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function openUrl(url) {
            // Open URL in a new tab
            window.open(url, '_blank');
        }
        async function loadData() {
            await loadTotal();
            await loadUrls();
        }
        async function loadTotal() {
            const res = await fetch('/api/total');
            const data = await res.json();
            document.getElementById('total-amount').innerText =
                `Total: ${data.total_amount.toFixed(2)} `;
        }

        
        async function loadUrls() {
            await loadTotal();
            try {
                const response = await fetch('/api/urls');
                const urls = await response.json();
                
                const urlList = document.getElementById('url-list');
                
                if (urls.length === 0) {
                    urlList.innerHTML = '<div class="empty-state">No URLs found. Upload a file or add one manually.</div>';
                    return;
                }
                
                let html = '';
                urls.forEach(url => {
                    // Escape single quotes in URL to prevent breaking HTML
                    const escapedUrl = url.url.replace(/'/g, "\\'");
                    html += `
                        <div class="url-item">
                            <div class="url-info">
                                <button class="url-text" onclick="openUrl('${escapedUrl}')">${url.url}</button>
                                <div class="amount-text">${url.amount.toFixed(2)} shekel</div>
                            </div>
                            <button class="remove-btn" onclick="removeUrl(${url.id})">Remove</button>
                        </div>
                    `;
                });
                
                urlList.innerHTML = html;
            } catch (error) {
                document.getElementById('url-list').innerHTML = 
                    '<div class="empty-state">Error loading URLs: ' + error.message + '</div>';
            }
        }
        
        async function loadAllUrls() {

            try {
                const response = await fetch('/api/allurls');
                const urls = await response.json();
                
                const urlList = document.getElementById('url-list');
                
                if (urls.length === 0) {
                    urlList.innerHTML = '<div class="empty-state">No URLs found. Upload a file or add one manually.</div>';
                    return;
                }
                
                let html = '';
                urls.forEach(url => {
                    // Escape single quotes in URL to prevent breaking HTML
                    const escapedUrl = url.url.replace(/'/g, "\\'");
                    const isUsed = url.used === 1 || url.used === true;
                    const usedClass = isUsed ? 'used' : '';
                    const usedBadge = isUsed ? '<span class="used-badge">USED</span>' : '';
                    
                    html += `
                        <div class="url-item ${usedClass}">
                            <div class="url-info">
                                <button class="url-text" onclick="openUrl('${escapedUrl}')">${url.url}</button>
                                <div class="amount-text">${url.amount.toFixed(2)} shekel ${usedBadge}</div>
                                <div class="date">Added At: ${url.created_at}</div>
                            </div>
                            ${!isUsed ? `<button class="remove-btn" onclick="removeUrl(${url.id})">Remove</button>` : ''}
                        </div>
                    `;
                });
                
                urlList.innerHTML = html;
            } catch (error) {
                document.getElementById('url-list').innerHTML = 
                    '<div class="empty-state">Error loading URLs: ' + error.message + '</div>';
            }
        }
    </script>
</body>
</html>

